<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>„Ç∑„É≥„Éó„É´ÈõªÂçì</title>
<style>
:root{
  --bg:#f2f2f7;
  --card:#fff;
  --text:#000;
  --button:#e8e8eb;
  --button-hover:#e0e0e4;
  --operator:#ff9500;
  --operator-shadow:rgba(255, 149, 0, 0.3);
  --muted:rgba(0,0,0,0.45);
  --border:rgba(0,0,0,0.1);
  --shadow-hover: 0 12px 24px rgba(0,0,0,0.12), 0 4px 8px rgba(0,0,0,0.06);
}
body.dark{
  --bg:#111113;
  --card:#1e1e20;
  --text:#fff;
  --button:#2b2b2d;
  --button-hover:#3b3b3d;
  --operator:#ff9f0a;
  --operator-shadow:rgba(255, 159, 10, 0.4);
  --muted:rgba(255,255,255,0.45);
  --border:rgba(255,255,255,0.1);
  --shadow-hover: 0 15px 30px rgba(0,0,0,0.5), 0 5px 15px rgba(0,0,0,0.3);
}
*{box-sizing:border-box}
body{
  margin:0;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  background:var(--bg);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  color:var(--text);
  transition:background .20s, color .20s;
}

.top-buttons {
  position: fixed;
  top: 12px;
  right: 12px;
  display:flex;
  gap:8px;
  z-index:1000;
}
.top-btn {
  background:var(--button);
  border:1px solid transparent;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  color:var(--text);
  font-size:0.98rem;
  transition: all 0.2s;
}
.top-btn:hover { 
  background: var(--button-hover);
  box-shadow: var(--shadow-hover);
  transform: translateY(-2px);
}

.calculator-wrapper{
  width:1280px;
  max-width:98%;
  background:var(--card);
  border-radius:16px;
  padding:22px;
  box-shadow:0 14px 36px rgba(0,0,0,0.08);
  display:flex;
  gap:30px;
}

.left-panel{
  display:grid;
  grid-template-columns:repeat(4,86px);
  grid-auto-rows:68px;
  gap:12px;
  align-content:start;
}

.btn{
  background:var(--button);
  border:none;
  border-radius:14px;
  font-size:1.2rem;
  cursor:pointer;
  color:var(--text);
  transition: transform 180ms cubic-bezier(.2,.9,.3,1), box-shadow 180ms, background 120ms;
  box-shadow: 0 4px 10px rgba(0,0,0,0.04);
  display:flex;
  align-items:center;
  justify-content:center;
}
.btn:hover{
  transform: translateY(-5px) scale(1.05);
  box-shadow: var(--shadow-hover);
  background: var(--button-hover);
}
.btn.operator{ background:var(--operator); color:#fff; }
.btn.operator:hover{ box-shadow: 0 12px 24px var(--operator-shadow), 0 4px 8px rgba(0,0,0,0.1); }
.btn:active { transform: translateY(2px) scale(0.98); }

.pos-c{grid-area:1/1}.pos-back{grid-area:1/2}.pos-ac{grid-area:1/3}.pos-div{grid-area:1/4}
.pos-7{grid-area:2/1}.pos-8{grid-area:2/2}.pos-9{grid-area:2/3}.pos-mul{grid-area:2/4}
.pos-4{grid-area:3/1}.pos-5{grid-area:3/2}.pos-6{grid-area:3/3}.pos-sub{grid-area:3/4}
.pos-1{grid-area:4/1}.pos-2{grid-area:4/2}.pos-3{grid-area:4/3}.pos-add{grid-area:4/4}
.pos-0{grid-area:5/1}.pos-dot{grid-area:5/2}.pos-x2{grid-area:5/3}.pos-sqrt{grid-area:5/4}
.tz-cell{grid-column:1/span 2; grid-row:6; background:var(--button); border-radius:14px; display:flex; align-items:center; justify-content:center; gap:6px; font-size:0.9rem;}
.pos-eq{grid-column:3/span 2; grid-row:6}

.center-panel{ flex:1; display:flex; flex-direction:column; gap:12px; min-width:240px; }
.display{
  background:var(--bg);
  border-radius:12px;
  padding:16px;
  font-size:1.8rem;
  min-height:64px;
  text-align:right;
  word-break:break-all;
  box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
}
.history{ background:var(--bg); border-radius:10px; padding:8px; flex:1; max-height:450px; overflow:auto; }
.history-item{ padding:8px; border-radius:8px; cursor:pointer; font-size:0.9rem; margin-bottom:4px; transition: 0.2s; }
.history-item:hover{ background:var(--button); transform: translateX(5px); }

.memo-panel{ width:380px; border-left:1px solid var(--border); padding-left:24px; display:flex; flex-direction:column; gap:12px; }
.memo-header{ display:flex; gap:8px; align-items:center; }
.memo-title-input{ flex:1; background:var(--bg); border:none; padding:10px; border-radius:8px; color:var(--text); font-weight:bold; font-size:1rem; }
.memo-add-btn{
  background:var(--operator); color:#fff; border:none; width:40px; height:40px; border-radius:50%;
  cursor:pointer; font-size:1.5rem; display:flex; align-items:center; justify-content:center; transition: all 0.2s;
}
.memo-add-btn:hover{ transform: scale(1.15) rotate(90deg); box-shadow: 0 5px 15px var(--operator-shadow); }
.memo-area{
  width:100%; height:200px; background:var(--bg); border:none; border-radius:10px; padding:14px;
  color:var(--text); font-family:inherit; font-size:0.95rem; resize:none; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
}
.memo-history{ flex:1; overflow-y:auto; background:var(--bg); border-radius:10px; padding:8px; }
.memo-history-item{ padding:10px; border-bottom:1px solid var(--border); font-size:0.85rem; transition: 0.2s; }
.memo-history-item:hover { background: var(--button); border-radius: 8px; }

.copy-notification{
  position:fixed; top:80px; right:12px; background:var(--operator); color:#fff;
  padding:10px 16px; border-radius:8px; opacity:0; pointer-events:none; transition: .2s;
  box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}
.copy-notification.show{ opacity:1; }

@media (max-width:1000px){
  .calculator-wrapper{ flex-direction:column; width:95%; align-items:stretch; }
  .memo-panel{ width:100%; border-left:none; border-top:1px solid var(--border); padding:20px 0 0; }
  .left-panel{ grid-template-columns: repeat(4, 1fr); }
}
</style>
</head>
<body class="dark">

<div class="top-buttons">
  <button class="top-btn" id="kanjiToggleBtn" onclick="toggleKanji()">Êº¢Â≠óË°®Á§∫: OFF</button>
  <button class="top-btn" id="volBtn" onclick="toggleVolume()">üîä</button>
  <button class="top-btn" id="toggleBtn" onclick="toggleDarkMode()">‚òÄÔ∏è</button>
</div>

<div class="copy-notification" id="copyNotif">üìã „Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü</div>

<div class="calculator-wrapper">
  <div class="left-panel">
    <button class="btn pos-c" onclick="clearResult()">C</button>
    <button class="btn pos-back" onclick="backspace()">‚å´</button>
    <button class="btn pos-ac" onclick="clearHistoryOnly()">AC</button>
    <button class="btn operator pos-div" onclick="press('√∑')">√∑</button>
    <button class="btn pos-7" onclick="press('7')">7</button>
    <button class="btn pos-8" onclick="press('8')">8</button>
    <button class="btn pos-9" onclick="press('9')">9</button>
    <button class="btn operator pos-mul" onclick="press('√ó')">√ó</button>
    <button class="btn pos-4" onclick="press('4')">4</button>
    <button class="btn pos-5" onclick="press('5')">5</button>
    <button class="btn pos-6" onclick="press('6')">6</button>
    <button class="btn operator pos-sub" onclick="press('-')">‚àí</button>
    <button class="btn pos-1" onclick="press('1')">1</button>
    <button class="btn pos-2" onclick="press('2')">2</button>
    <button class="btn pos-3" onclick="press('3')">3</button>
    <button class="btn operator pos-add" onclick="press('+')">+</button>
    <button class="btn pos-0" onclick="press('0')">0</button>
    <button class="btn pos-dot" onclick="press('.')">.</button>
    <button class="btn pos-x2" onclick="press('x¬≤')">x¬≤</button>
    <button class="btn pos-sqrt" onclick="press('‚àö')">‚àö</button>
    <div class="tz-cell" title="Êù±‰∫¨ (JST)"><span id="tzIcon">üåÖ</span> <span id="tzTime">--:--:--</span> üáØüáµ</div>
    <button class="btn operator pos-eq" onclick="press('=')">=</button>
  </div>

  <div class="center-panel">
    <div style="font-size:0.8rem; opacity:0.6">Ë®àÁÆóÁµêÊûú</div>
    <div class="display" id="display">0</div>
    <div style="font-size:0.8rem; opacity:0.6">Ë®àÁÆóÂ±•Ê≠¥(„ÇØ„É™„ÉÉ„ÇØ„Åß„Ç≥„Éî„Éº)</div>
    <div class="history" id="history"></div>
  </div>

  <div class="memo-panel">
    <div style="font-size:0.8rem; opacity:0.6">„É°„É¢ÂÖ•Âäõ</div>
    <div class="memo-header">
      <input type="text" id="memoTitle" class="memo-title-input" placeholder="„Çø„Ç§„Éà„É´„Å™„Åó">
      <button class="memo-add-btn" onclick="archiveMemo()" title="Â±•Ê≠¥„Å´‰øùÂ≠ò">+</button>
    </div>
    <textarea id="memoBody" class="memo-area" placeholder="„Åì„Åì„Å´„É°„É¢„ÇíÊõ∏„ÅÑ„Å¶„Å≠..."></textarea>
    <div style="font-size:0.8rem; opacity:0.6; margin-top:10px;">„É°„É¢Â±•Ê≠¥</div>
    <div class="memo-history" id="memoHistory"></div>
  </div>
</div>

<script>
/* Âü∫Êú¨Ë®≠ÂÆö */
const display = document.getElementById('display');
const historyEl = document.getElementById('history');
const memoTitle = document.getElementById('memoTitle');
const memoBody = document.getElementById('memoBody');
const memoHistoryEl = document.getElementById('memoHistory');
const volBtn = document.getElementById('volBtn');

let formulaDisplay = '', formulaEval = '', lastWasEqual = false;
let darkMode = true, useKanjiCompact = false, volumeOn = true;

/* --- Êº¢Â≠óÊ°ÅË°®Á§∫Áî®„É≠„Ç∏„ÉÉ„ÇØ --- */
const KANJI_UNITS = [
  {value: 1e20, unit: 'Âûì'},
  {value: 1e16, unit: '‰∫¨'},
  {value: 1e12, unit: 'ÂÖÜ'},
  {value: 1e8, unit: 'ÂÑÑ'},
  {value: 1e4, unit: '‰∏á'}
];

function formatNumberKanji(numStr) {
  const num = parseFloat(numStr);
  if (isNaN(num) || !isFinite(num)) return numStr;
  
  const abs = Math.abs(num);
  const sign = num < 0 ? '-' : '';
  
  // 1‰∏áÊú™Ê∫Ä„ÅØ„Åù„ÅÆ„Åæ„Åæ(„Ç´„É≥„ÉûÂå∫Âàá„Çä)
  if (abs < 10000) return sign + num.toLocaleString('ja-JP');

  for (const u of KANJI_UNITS) {
    if (abs >= u.value) {
      // Â∞èÊï∞ÁÇπÁ¨¨2‰Ωç„Åæ„ÅßË°®Á§∫„Åó„Å¶‰∏çË¶Å„Å™0„ÇíÊ∂à„Åô
      const v = Math.floor((abs / u.value) * 100) / 100;
      return sign + v.toString() + u.unit;
    }
  }
  return sign + num.toLocaleString('ja-JP');
}

/* --- „Çµ„Ç¶„É≥„ÉâÁîüÊàê („Ç≥„Éà„Ç≥„ÉàÈü≥) --- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playKotoSound() {
  if(!volumeOn) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine'; 
  osc.frequency.setValueAtTime(150, audioCtx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
  gain.gain.setValueAtTime(0.04, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime + 0.1);
}

document.querySelectorAll('button').forEach(btn => {
  btn.addEventListener('mouseenter', playKotoSound);
});

/* --- ÈõªÂçìÊ©üËÉΩ --- */
function updateDisplay(){
  if(formulaDisplay === '') { display.innerText = '0'; return; }
  
  // ÊºîÁÆóÂ≠ê„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Å™„Åè„Å¶Êº¢Â≠ó„É¢„Éº„Éâ„ÅåON„Å™„ÇâÂ§âÊèõ
  const hasOperator = /[+\-√ó√∑]/.test(formulaDisplay);
  if(useKanjiCompact && !hasOperator) {
    display.innerText = formatNumberKanji(formulaDisplay);
  } else {
    display.innerText = formulaDisplay;
  }
}

function press(key){
  if(/[0-9.]/.test(key)){
    if(lastWasEqual){ formulaDisplay = ''; formulaEval = ''; lastWasEqual = false; }
    formulaDisplay += key; formulaEval += key;
  } else if(['+','-','√ó','√∑'].includes(key)){
    lastWasEqual = false;
    const op = key==='√ó'?'*': key==='√∑'?'/': key;
    formulaDisplay += ' ' + key + ' '; formulaEval += op;
  } else if(key === '=') { calculate(); return; }
  updateDisplay();
}

function calculate(){
  try {
    const result = eval(formulaEval.replace(/√ó/g,'*').replace(/√∑/g,'/'));
    const rounded = Math.round(result * 100000000) / 100000000;
    const historyText = formulaDisplay + ' = ' + rounded;
    
    const item = document.createElement('div');
    item.className = 'history-item';
    item.innerText = historyText;
    item.onclick = () => copyText(String(rounded));
    historyEl.prepend(item);
    
    formulaDisplay = String(rounded); formulaEval = String(rounded); lastWasEqual = true;
    updateDisplay();
  } catch(e) { display.innerText = '„Ç®„É©„Éº'; }
}

function clearResult(){ formulaDisplay = ''; formulaEval = ''; updateDisplay(); }
function clearHistoryOnly(){ historyEl.innerHTML = ''; }
function backspace(){ formulaDisplay = formulaDisplay.slice(0,-1); updateDisplay(); }

/* --- „É°„É¢Ê©üËÉΩ --- */
function archiveMemo() {
  const title = memoTitle.value.trim() || "„Çø„Ç§„Éà„É´„Å™„Åó";
  const body = memoBody.value.trim();
  if(!body && title === "„Çø„Ç§„Éà„É´„Å™„Åó") return;
  const time = new Date().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
  const item = document.createElement('div');
  item.className = 'memo-history-item';
  item.innerHTML = `<div class="memo-h-title">${title} <span style="font-weight:normal; opacity:0.5; font-size:0.7rem;">${time}</span></div><div style="white-space:pre-wrap; opacity:0.8">${body}</div>`;
  memoHistoryEl.prepend(item);
  memoTitle.value = ''; memoBody.value = '';
}

/* --- UIË®≠ÂÆö --- */
function toggleVolume(){
  volumeOn = !volumeOn;
  volBtn.innerText = volumeOn ? 'üîä' : 'üîá';
  if(audioCtx.state === 'suspended') audioCtx.resume();
}
function toggleDarkMode(){
  darkMode = !darkMode;
  document.body.classList.toggle('dark', darkMode);
  document.getElementById('toggleBtn').innerText = darkMode ? '‚òÄÔ∏è' : 'üåô';
}
function toggleKanji(){
  useKanjiCompact = !useKanjiCompact;
  document.getElementById('kanjiToggleBtn').innerText = 'Êº¢Â≠óË°®Á§∫: ' + (useKanjiCompact ? 'ON' : 'OFF');
  updateDisplay(); // Âç≥Â∫ß„Å´‰ªä„ÅÆÊï∞Â≠ó„ÇíÂ§âÊèõ
}
function copyText(txt){
  navigator.clipboard.writeText(txt);
  const notif = document.getElementById('copyNotif');
  notif.classList.add('show'); setTimeout(()=>notif.classList.remove('show'), 1500);
}

function updateClock() {
  const now = new Date();
  document.getElementById('tzTime').innerText = now.toLocaleTimeString('ja-JP', {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
}
setInterval(updateClock, 1000);
updateClock();
</script>
</body>
</html>