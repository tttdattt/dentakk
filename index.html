<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>„Ç∑„É≥„Éó„É´ÈõªÂçì</title>
<style>
:root{
  --bg:#f2f2f7;
  --card:#fff;
  --text:#000;
  --button:#e8e8eb;
  --button-hover:#e0e0e4;
  --operator:#ff9500;
  --operator-shadow:rgba(255, 149, 0, 0.3);
  --muted:rgba(0,0,0,0.45);
  --border:rgba(0,0,0,0.1);
  --shadow-hover: 0 12px 24px rgba(0,0,0,0.12), 0 4px 8px rgba(0,0,0,0.06);
  --power-active:#7c3aed;
  --power-shadow:rgba(124, 58, 237, 0.5);
}
body.dark{
  --bg:#111113;
  --card:#1e1e20;
  --text:#fff;
  --button:#2b2b2d;
  --button-hover:#3b3b3d;
  --operator:#ff9f0a;
  --operator-shadow:rgba(255, 159, 10, 0.4);
  --muted:rgba(255,255,255,0.45);
  --border:rgba(255,255,255,0.1);
  --shadow-hover: 0 15px 30px rgba(0,0,0,0.5), 0 5px 15px rgba(0,0,0,0.3);
  --power-active:#a78bfa;
  --power-shadow:rgba(167, 139, 250, 0.5);
}
*{box-sizing:border-box}
body{
  margin:0;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  background:var(--bg);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  color:var(--text);
  transition:background .20s, color .20s;
}

.top-buttons {
  position: fixed;
  top: 12px;
  right: 12px;
  display:flex;
  gap:8px;
  z-index:1000;
}
.top-btn {
  background:rgba(232, 232, 235, 0.8);
  backdrop-filter: blur(10px);
  border:1px solid rgba(0,0,0,0.1);
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  color:var(--text);
  font-size:0.98rem;
  transition: all 0.2s;
}
body.dark .top-btn {
  background:rgba(43, 43, 45, 0.8);
  border:1px solid rgba(255,255,255,0.1);
}
.top-btn:hover { 
  background: var(--button-hover);
  box-shadow: var(--shadow-hover);
  transform: translateY(-2px);
}

.calculator-wrapper{
  width:1280px;
  max-width:98%;
  background:rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border:1px solid rgba(255, 255, 255, 0.3);
  border-radius:20px;
  padding:22px;
  box-shadow:0 14px 36px rgba(0,0,0,0.08), 0 8px 16px rgba(0,0,0,0.04);
  display:flex;
  gap:30px;
}
body.dark .calculator-wrapper{
  background:rgba(30, 30, 32, 0.7);
  border:1px solid rgba(255, 255, 255, 0.1);
}

.left-panel{
  display:grid;
  grid-template-columns:repeat(4,86px);
  grid-auto-rows:68px;
  gap:12px;
  align-content:start;
}

.btn{
  background:rgba(232, 232, 235, 0.8);
  backdrop-filter: blur(10px);
  border:1px solid rgba(0,0,0,0.1);
  border-radius:14px;
  font-size:1.2rem;
  cursor:pointer;
  color:var(--text);
  transition: transform 180ms cubic-bezier(.2,.9,.3,1), box-shadow 180ms, background 120ms;
  box-shadow: 0 4px 10px rgba(0,0,0,0.04);
  display:flex;
  align-items:center;
  justify-content:center;
}
body.dark .btn{
  background:rgba(43, 43, 45, 0.8);
  border:1px solid rgba(255,255,255,0.1);
}
.btn:hover{
  transform: translateY(-5px) scale(1.05);
  box-shadow: var(--shadow-hover);
  background: var(--button-hover);
}
.btn.operator{ background:var(--operator); color:#fff; border:1px solid transparent; }
.btn.operator:hover{ box-shadow: 0 12px 24px var(--operator-shadow), 0 4px 8px rgba(0,0,0,0.1); }
.btn:active { transform: translateY(2px) scale(0.98); }
.btn.power-active { background:var(--power-active); color:#fff; border:1px solid transparent; }
.btn.power-active:hover { box-shadow: 0 12px 24px var(--power-shadow), 0 4px 8px rgba(0,0,0,0.1); }

.pos-c{grid-area:1/1}.pos-back{grid-area:1/2}.pos-ac{grid-area:1/3}.pos-div{grid-area:1/4}
.pos-7{grid-area:2/1}.pos-8{grid-area:2/2}.pos-9{grid-area:2/3}.pos-mul{grid-area:2/4}
.pos-4{grid-area:3/1}.pos-5{grid-area:3/2}.pos-6{grid-area:3/3}.pos-sub{grid-area:3/4}
.pos-1{grid-area:4/1}.pos-2{grid-area:4/2}.pos-3{grid-area:4/3}.pos-add{grid-area:4/4}
.pos-0{grid-area:5/1}.pos-dot{grid-area:5/2}.pos-x2{grid-area:5/3}.pos-sqrt{grid-area:5/4}
.tz-cell{
  grid-column:1/span 2; 
  grid-row:6; 
  background:rgba(232, 232, 235, 0.8);
  backdrop-filter: blur(10px);
  border:1px solid rgba(0,0,0,0.1);
  border-radius:14px; 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  gap:6px; 
  font-size:0.9rem;
}
body.dark .tz-cell{
  background:rgba(43, 43, 45, 0.8);
  border:1px solid rgba(255,255,255,0.1);
}
.pos-eq{grid-column:3/span 2; grid-row:6}

.center-panel{ flex:1; display:flex; flex-direction:column; gap:12px; min-width:240px; }
.display{
  background:rgba(242, 242, 247, 0.5);
  backdrop-filter: blur(10px);
  border:1px solid rgba(0,0,0,0.1);
  border-radius:12px;
  padding:16px;
  font-size:1.8rem;
  min-height:64px;
  text-align:right;
  word-break:break-all;
  box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
}
.display sup {
  font-size: 1rem;
  vertical-align: super;
}
body.dark .display{
  background:rgba(43, 43, 45, 0.5);
  border:1px solid rgba(255,255,255,0.1);
}
.history{ 
  background:rgba(242, 242, 247, 0.5); 
  backdrop-filter: blur(10px);
  border:1px solid rgba(0,0,0,0.1);
  border-radius:12px; 
  padding:8px; 
  flex:1; 
  max-height:450px; 
  overflow:auto; 
}
body.dark .history{
  background:rgba(43, 43, 45, 0.5);
  border:1px solid rgba(255,255,255,0.1);
}
.history-item{ padding:8px; border-radius:8px; cursor:pointer; font-size:0.9rem; margin-bottom:4px; transition: 0.2s; }
.history-item:hover{ background:var(--button); transform: translateX(5px); }
.history-item sup {
  font-size: 0.6rem;
  vertical-align: super;
}

.memo-panel{ width:380px; border-left:1px solid var(--border); padding-left:24px; display:flex; flex-direction:column; gap:12px; }
.memo-area{
  width:100%; flex:1; min-height:400px; background:rgba(242, 242, 247, 0.5); backdrop-filter: blur(10px);
  border:1px solid rgba(0,0,0,0.1); border-radius:12px; padding:16px;
  color:var(--text); font-family:inherit; font-size:0.95rem; resize:none; 
  box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
}
body.dark .memo-area{
  background:rgba(43, 43, 45, 0.5);
  border:1px solid rgba(255,255,255,0.1);
}

.copy-notification{
  position:fixed; 
  top:80px; 
  right:12px; 
  background:var(--operator); 
  color:#fff;
  padding:10px 16px; 
  border-radius:10px; 
  opacity:0; 
  pointer-events:none; 
  transition: .2s;
  box-shadow: 0 10px 20px rgba(0,0,0,0.2);
  backdrop-filter: blur(10px);
}
.copy-notification.show{ opacity:1; }

@media (max-width:1000px){
  .calculator-wrapper{ flex-direction:column; width:95%; align-items:stretch; }
  .memo-panel{ width:100%; border-left:none; border-top:1px solid var(--border); padding:20px 0 0; }
  .left-panel{ grid-template-columns: repeat(4, 1fr); }
}
</style>
</head>
<body class="dark">

<div class="top-buttons">
  <button class="top-btn" id="kanjiToggleBtn" onclick="toggleKanji()">Êº¢Â≠óË°®Á§∫: OFF</button>
  <button class="top-btn" id="volBtn" onclick="toggleVolume()">üîä</button>
  <button class="top-btn" id="toggleBtn" onclick="toggleDarkMode()">‚òÄÔ∏è</button>
</div>

<div class="copy-notification" id="copyNotif">üìã „Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü</div>

<div class="calculator-wrapper">
  <div class="left-panel">
    <button class="btn pos-c" onclick="clearResult()">C</button>
    <button class="btn pos-back" onclick="backspace()">‚å´</button>
    <button class="btn pos-ac" onclick="clearHistoryOnly()">AC</button>
    <button class="btn operator pos-div" onclick="press('√∑')">√∑</button>
    <button class="btn pos-7" onclick="press('7')">7</button>
    <button class="btn pos-8" onclick="press('8')">8</button>
    <button class="btn pos-9" onclick="press('9')">9</button>
    <button class="btn operator pos-mul" onclick="press('√ó')">√ó</button>
    <button class="btn pos-4" onclick="press('4')">4</button>
    <button class="btn pos-5" onclick="press('5')">5</button>
    <button class="btn pos-6" onclick="press('6')">6</button>
    <button class="btn operator pos-sub" onclick="press('-')">‚àí</button>
    <button class="btn pos-1" onclick="press('1')">1</button>
    <button class="btn pos-2" onclick="press('2')">2</button>
    <button class="btn pos-3" onclick="press('3')">3</button>
    <button class="btn operator pos-add" onclick="press('+')">+</button>
    <button class="btn pos-0" onclick="press('0')">0</button>
    <button class="btn pos-dot" onclick="press('.')">.</button>
    <button class="btn pos-x2" id="powerBtn" onclick="togglePowerMode()">x‚Åø</button>
    <button class="btn pos-sqrt" onclick="pressPercent()">%</button>
    <div class="tz-cell" title="Êù±‰∫¨ (JST)"><span id="tzIcon">üåÖ</span> <span id="tzTime">--:--:--</span> üáØüáµ</div>
    <button class="btn operator pos-eq" onclick="calculate()">=</button>
  </div>

  <div class="center-panel">
    <div style="font-size:0.8rem; opacity:0.6">Ë®àÁÆóÁµêÊûú</div>
    <div class="display" id="display">0</div>
    <div style="font-size:0.8rem; opacity:0.6">Ë®àÁÆóÂ±•Ê≠¥(„ÇØ„É™„ÉÉ„ÇØ„Åß„Ç≥„Éî„Éº)</div>
    <div class="history" id="history"></div>
  </div>

  <div class="memo-panel">
    <div style="font-size:0.8rem; opacity:0.6; margin-bottom:10px;">„É°„É¢</div>
    <textarea id="memoBody" class="memo-area" placeholder="„Åì„Åì„Å´„É°„É¢„ÇíÊõ∏„ÅÑ„Å¶„Å≠..."></textarea>
  </div>
</div>

<script>
/* Âü∫Êú¨Ë®≠ÂÆö */
const display = document.getElementById('display');
const historyEl = document.getElementById('history');
const memoBody = document.getElementById('memoBody');
const volBtn = document.getElementById('volBtn');
const powerBtn = document.getElementById('powerBtn');

let formulaDisplay = '', formulaEval = '', lastWasEqual = false;
let darkMode = true, useKanjiCompact = false, volumeOn = true;
let powerMode = false, powerBase = '';

/* --- „É°„É¢Ê©üËÉΩÔºàlocalStorageÔºâ --- */
function saveMemo() {
  try {
    localStorage.setItem('calcMemo', memoBody.value);
  } catch(e) { console.error('‰øùÂ≠ò„Ç®„É©„Éº:', e); }
}
function loadMemo() {
  try {
    const saved = localStorage.getItem('calcMemo');
    if(saved !== null) memoBody.value = saved;
  } catch(e) { console.error('Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e); }
}
memoBody.addEventListener('input', saveMemo);
loadMemo();

/* --- Êº¢Â≠óÊ°ÅË°®Á§∫Áî®„É≠„Ç∏„ÉÉ„ÇØ --- */
const KANJI_UNITS = [
  {value: 1e20, unit: 'Âûì'},
  {value: 1e16, unit: '‰∫¨'},
  {value: 1e12, unit: 'ÂÖÜ'},
  {value: 1e8, unit: 'ÂÑÑ'},
  {value: 1e4, unit: '‰∏á'}
];

function formatNumberKanji(numStr) {
  const num = parseFloat(numStr);
  if (isNaN(num) || !isFinite(num)) return numStr;
  
  const abs = Math.abs(num);
  const sign = num < 0 ? '-' : '';
  
  if (abs < 10000) return sign + num.toLocaleString('ja-JP');

  for (const u of KANJI_UNITS) {
    if (abs >= u.value) {
      const v = Math.floor((abs / u.value) * 100) / 100;
      return sign + v.toString() + u.unit;
    }
  }
  return sign + num.toLocaleString('ja-JP');
}

/* --- „Çµ„Ç¶„É≥„ÉâÁîüÊàê („Ç≥„Éà„Ç≥„ÉàÈü≥) --- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playKotoSound() {
  if(!volumeOn) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine'; 
  osc.frequency.setValueAtTime(150, audioCtx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
  gain.gain.setValueAtTime(0.04, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime + 0.1);
}

document.querySelectorAll('button').forEach(btn => {
  btn.addEventListener('mouseenter', playKotoSound);
});

/* --- ÈõªÂçìÊ©üËÉΩ --- */
function updateDisplay(){
  if(formulaDisplay === '') { 
    display.innerHTML = '0'; 
    return; 
  }
  
  let displayText = formulaDisplay;
  const hasOperator = /[+\-√ó√∑]/.test(formulaDisplay.replace(/\^[\d.]+/g, '')); 
  
  if(useKanjiCompact && !hasOperator && !displayText.includes('^')) {
    display.innerHTML = formatNumberKanji(formulaDisplay);
  } else {
    // ^„ÅÆÂæå„ÅÆÊï∞Â≠ó„Çí‰∏ä‰ªò„ÅçÊñáÂ≠ó„Å´Â§âÊèõ
    displayText = displayText.replace(/\^([\d.]+)/g, '<sup>$1</sup>');
    display.innerHTML = displayText;
  }
}

function press(key){
  if(/[0-9.]/.test(key)){
    if(lastWasEqual){ 
      formulaDisplay = ''; 
      formulaEval = ''; 
      lastWasEqual = false; 
      powerMode = false;
      powerBase = '';
      powerBtn.classList.remove('power-active');
    }
    
    formulaDisplay += key;
    
    // ‰πó„É¢„Éº„Éâ‰∏≠„ÅØformulaEval„Å´„ÅØËøΩÂä†„Åó„Å™„ÅÑ
    if(!powerMode) {
      formulaEval += key;
    }
  } else if(['+','-','√ó','√∑'].includes(key)){
    if(powerMode) completePowerMode();
    lastWasEqual = false;
    const op = key==='√ó'?'*': key==='√∑'?'/': key;
    formulaDisplay += ' ' + key + ' '; 
    formulaEval += op;
  }
  updateDisplay();
}

function pressPercent() {
  if(!formulaEval) return;
  const match = formulaEval.match(/([\d.]+)$/);
  if(match) {
    const num = parseFloat(match[1]);
    const percentage = num / 100;
    formulaEval = formulaEval.slice(0, -match[1].length) + percentage;
    formulaDisplay = formulaDisplay.slice(0, -match[1].length) + num + '%';
    updateDisplay();
  }
}

/* --- Ë®àÁÆóÂÆüË°å (‰øÆÊ≠£ÁÆáÊâÄ) --- */
function calculate(){
  try {
    // „Äê‰øÆÊ≠£„Äë‰πó„É¢„Éº„Éâ‰∏≠„Å™„ÇâÂº∑Âà∂ÁöÑ„Å´Á¢∫ÂÆöÂá¶ÁêÜ„ÇíÂÆüË°å
    if(powerMode) {
      completePowerMode();
    }

    if(!formulaEval || formulaEval.trim() === '') return;
    
    const result = eval(formulaEval);
    if(!isFinite(result)) {
      display.innerHTML = '„Ç®„É©„Éº';
      return;
    }
    
    const rounded = Math.round(result * 100000000) / 100000000;
    const historyText = formulaDisplay.replace(/\^([\d.]+)/g, '<sup>$1</sup>') + ' = ' + rounded;
    
    const item = document.createElement('div');
    item.className = 'history-item';
    item.innerHTML = historyText;
    item.onclick = () => copyText(String(rounded));
    historyEl.prepend(item);
    
    formulaDisplay = String(rounded); 
    formulaEval = String(rounded); 
    lastWasEqual = true;
    powerMode = false;
    powerBase = '';
    powerBtn.classList.remove('power-active');
    updateDisplay();
  } catch(e) { 
    display.innerHTML = '„Ç®„É©„Éº'; 
    console.error('Ë®àÁÆó„Ç®„É©„Éº:', e);
  }
}

/* --- ‰πó„É¢„Éº„ÉâÊ©üËÉΩ (‰øÆÊ≠£ÁÆáÊâÄ) --- */
function togglePowerMode() {
  if(!powerMode) {
    // ‰πó„É¢„Éº„ÉâÈñãÂßã
    const match = formulaEval.match(/([\d.]+)$/);
    if(match) {
      powerBase = match[1];
      powerMode = true;
      powerBtn.classList.add('power-active');
      
      // formulaEval„Åã„ÇâÂ∫ï„ÇíÂâäÈô§
      formulaEval = formulaEval.slice(0, -powerBase.length);
      
      // Ë°®Á§∫„Å´^„ÇíËøΩÂä†
      formulaDisplay += '^';
    }
  } else {
    // ‰πó„É¢„Éº„ÉâÁµÇ‰∫Ü
    completePowerMode();
  }
  updateDisplay();
}

function completePowerMode() {
  if(!powerMode) return;
  
  // ÊåáÊï∞ÈÉ®ÂàÜ„ÇíÂèñÂæóÔºàÊ≠£Ë¶èË°®Áèæ„ÇíË™øÊï¥Ôºâ
  const exponentMatch = formulaDisplay.match(/\^([\d.]+)$/);
  if(exponentMatch) {
    const exponent = exponentMatch[1];
    formulaEval += `Math.pow(${powerBase},${exponent})`;
  } else {
    // ÊåáÊï∞„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ^„ÇíÂâäÈô§„Åó„Å¶Â∫ï„ÇíÊàª„Åô
    formulaDisplay = formulaDisplay.replace(/\^$/, '');
    formulaEval += powerBase;
  }
  
  powerMode = false;
  powerBase = '';
  powerBtn.classList.remove('power-active');
  // „Åì„Åì„Åß„ÅØupdateDisplay„ÅØÂëº„Å∞„Åö„ÄÅÂëº„Å≥Âá∫„ÅóÂÖÉ„Å´‰ªª„Åõ„Çã„Åã„ÄÅcalculate„ÅßÊõ¥Êñ∞„Åô„Çã
}

function clearResult(){ 
  formulaDisplay = ''; 
  formulaEval = ''; 
  powerMode = false;
  powerBase = '';
  powerBtn.classList.remove('power-active');
  updateDisplay(); 
}

function clearHistoryOnly(){ historyEl.innerHTML = ''; }

function backspace(){ 
  if(formulaDisplay.length > 0) {
    const lastChar = formulaDisplay.slice(-1);
    formulaDisplay = formulaDisplay.slice(0,-1);
    
    // ‰πó„É¢„Éº„Éâ‰∏≠„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøformulaEval„ÇÇÂâäÈô§
    if(!powerMode && formulaEval.length > 0) {
      formulaEval = formulaEval.slice(0,-1);
    }
    
    // ^„ÇíÂâäÈô§„Åó„ÅüÂ†¥Âêà„ÅØ‰πó„É¢„Éº„Éâ„ÇíÁµÇ‰∫Ü
    if(lastChar === '^') {
      powerMode = false;
      powerBase = '';
      powerBtn.classList.remove('power-active');
      formulaEval += powerBase;
      powerBase = '';
    }
  }
  updateDisplay(); 
}

/* --- UIË®≠ÂÆö --- */
function toggleVolume(){
  volumeOn = !volumeOn;
  volBtn.innerText = volumeOn ? 'üîä' : 'üîá';
  if(audioCtx.state === 'suspended') audioCtx.resume();
}

function toggleDarkMode(){
  darkMode = !darkMode;
  document.body.classList.toggle('dark', darkMode);
  document.getElementById('toggleBtn').innerText = darkMode ? '‚òÄÔ∏è' : 'üåô';
}

function toggleKanji(){
  useKanjiCompact = !useKanjiCompact;
  document.getElementById('kanjiToggleBtn').innerText = 'Êº¢Â≠óË°®Á§∫: ' + (useKanjiCompact ? 'ON' : 'OFF');
  updateDisplay();
}

function copyText(txt){
  navigator.clipboard.writeText(txt);
  const notif = document.getElementById('copyNotif');
  notif.classList.add('show'); 
  setTimeout(()=>notif.classList.remove('show'), 1500);
}

function updateClock() {
  const now = new Date();
  document.getElementById('tzTime').innerText = now.toLocaleTimeString('ja-JP', {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
}
setInterval(updateClock, 1000);
updateClock();
</script>
</body>
</html>